var app={};!function(){"use strict";var e,t=0,i=0,a=0,n=!1;app.vars={windowWidth:0,windowHeight:0,breakpointState:1,trueResize:!1,heightResize:!1,scroll_width:0,hasStorage:!1},app.EVENTS={INIT_COMPLETE:"init_complete",AMOUNT_CHANGE:"amount_change",CHECKBOX_CHANGE:"checkbox-change",CLIENT_LOADED:"client-loaded",CLIENT_PHOTOS_LOADED:"client-photos-loaded",CLIENT_UPDATED:"client-updated",HEADER_ATTR_RECALC:"header_attr_recalc",POPUP_OPENED:"popup-opened",TAB_CHANGE:"tab_change",VISIT_ADDED:"visit-added",INIT_LOADED_CONTENT:"init-loaded-content",CABINET_FORM_SUBMIT:"cabinet-form-submit"},app.selectors={body:"body",header:".header",main:".main",footer:".footer"},app.elements={},app.breakpoints={tablet:768,laptop:1240,desktop:1440},app.modules=[],app.init=function(){n||(n=!0,e=$(window),this.elements=this.elementsParse(this.selectors),this.vars.langGuid=this.elements.body.data("langGuid"),this.vars.windowWidth=e.outerWidth(),this.vars.windowWidth>=app.breakpoints.tablet&&(this.vars.breakpointState=2),this.vars.windowWidth>=app.breakpoints.laptop&&(this.vars.breakpointState=3),this.vars.windowWidth>=app.breakpoints.desktop&&(this.vars.breakpointState=4),"sessionStorage"in window&&window.sessionStorage&&(this.vars.hasStorage=!0),this.modulesInit(),this.listener(),this.resize(),this._loadState())},app.listener=function(){var t=$("body");e.resize(this._handleResize.bind(this)),t.on("submit",".api-form",this.apiFormSubmit.bind(this))},app.modulesInit=function(){var e=this;_.each(app,function(t,i){_.has(app,i)&&(_.isObject(app[i])||_.isFunction(app[i]))&&_.isFunction(app[i].init)&&e.modules.push(app[i])}),this.modules=_.sortBy(this.modules,function(e){return e.moduleOrder}),_.each(this.modules,function(e){e.init()})},app.initLoadedContent=function(){_.each(this.modules,function(e){_.isFunction(e.initLoadedContent)&&e.initLoadedContent()})},app._handleResize=function(){t&&clearTimeout(t),t=setTimeout(function(){app.resize()},100)},app.resize=function(){t&&clearTimeout(t),t=setTimeout(function(){this.vars.scroll_width=app.getScrollbarWidth(),this.vars.windowWidth=e.outerWidth(),this.vars.windowHeight=e.outerHeight(),(app.vars.windowHeight-i>=100||app.vars.windowHeight-i<=-100||a!==app.vars.windowWidth)&&(app.vars.trueResize=!0),a===app.vars.windowWidth&&i!==app.vars.windowHeight&&(app.vars.heightResize=!0),i=app.vars.windowHeight,a=app.vars.windowWidth,this.vars.breakpointState=1,this.vars.windowWidth>=app.breakpoints.tablet&&(this.vars.breakpointState=2),this.vars.windowWidth>=app.breakpoints.laptop&&(this.vars.breakpointState=3),this.vars.windowWidth>=app.breakpoints.desktop&&(this.vars.breakpointState=4),this.setMainBlockMinHeight(),_.each(app,function(e){_.has(app,e)&&(_.isObject(app[e])||_.isFunction(app[e]))&&_.isFunction(app[e].resize)&&app[e].resize()}),app.vars.trueResize=!1,app.vars.heightResize=!1}.bind(this),100)},app.getScrollbarWidth=function(){var e,t,i,a=document.createElement("div");return a.style.visibility="hidden",a.style.width="100px",a.style.msOverflowStyle="scrollbar",document.body.appendChild(a),e=a.offsetWidth,a.style.overflow="scroll",(t=document.createElement("div")).style.width="100%",a.appendChild(t),i=t.offsetWidth,a.parentNode.removeChild(a),e-i},app.isMobile=function(){return 1===this.vars.breakpointState},app.isTablet=function(){return 2===this.vars.breakpointState},app.isLaptop=function(){return this.vars.breakpointState>=3},app.isDesktop=function(){return 4===this.vars.breakpointState},app.formParse=function(e){var t={},i=e.serializeArray();return _.each(i,function(e){t[e.name]=e.value}),t},app.apiFormSubmit=function(e,t){var i=t||{},a=i.$form||$(e.currentTarget),n={type:"POST",url:"/",beforeSend:this.apiFormBeforeSend.bind(this,a)};e&&e.preventDefault&&e.preventDefault(),a.find(".api__form__message").html(""),n.dataType=i.dataType||"",n.success=i.success?i.success.bind(this,a):this.apiFormOnSuccess.bind(this,a),n.error=i.error?i.error.bind(this,a):this.apiFormOnError.bind(this,a),n.complete=i.complete?i.complete.bind(this,a):null,a.find('input.phone, [name="form[Телефон]"]').each(function(){var e=$(this),t=e.val();e.data("mask-init")&&t&&(e.data("mask-init",!1),e.inputmask("remove"),e.val("+7"+t))}),i.files_present?(n.data=new FormData(a[0]),n.cache=!1,n.processData=!1,n.contentType=!1):n.data=app.formParse(a),$.ajax(n)},app.apiFormBeforeSend=function(e){return!!app.validator.formValidate([],e)&&(e.addClass("preloader"),!0)},app.apiFormOnSuccess=function(e,t){var i=e.data("event");if(_.isObject(t))return e.find(".api__form__message").html('<div class="error__message">При отправке запроса произошла ошибка:'+t.response.message+"</div>"),void e.removeClass("preloader");i&&$("body").trigger(i),e.replaceWith(t)},app.apiFormOnError=function(e,t){var i='<div class="error__message">'+("При отправке формы произошла ошибка: "+JSON.stringify(t))+"</div>";e.removeClass("preloader"),e.find(".api__form__message").html(i)},app.elementsParse=function(e,t){var i=$(t).length?$(t):$("body"),a={};return _.each(e,function(e,t){var n=i.find(e);n.length?a[t]=n:i.is(e)?a[t]=i:a[t]=n}),a},app.getChildrenWidth=function(e){var t=0;return e.children().each(function(e,i){var a=$(i).outerWidth();t+=a}),t},app.setMainBlockMinHeight=function(){var e=$(app.selectors.header),t=$(app.selectors.main),i=$(app.selectors.footer),a=e.outerHeight(!0),n=i.outerHeight(!0);t.attr("data-no-calc")||t.css("min-height","calc(100vh - "+(a+n)+"px)")},app.preloader=function(){document.createElement("img").src="/content/img/preloader.svg"},app.padNum=function(e,t){for(var i=e.toString();i.length<t;)i="0"+i;return i},app.messageBox=function(e,t){var i=e,a="message";t.length&&(a+=" "+t),_.isString(i)&&(i=$('<div class="'+a+'">'+i+"</div>")),$.magnificPopup.open({items:{src:i,type:"inline",midClick:!0,closeBtnInside:!0}})},app.checkStatus=function(e){return new Promise(function(t,i){var a,n=!1;try{a=JSON.parse(e)}catch(t){a=e}_.isObject(a)?(a.status&&(401!==a.status&&403!==a.status&&408!==a.status||(n=!0)),a.response&&a.response.code&&400===a.response.code&&(n=!0),n&&window.location.reload(),t(a)):t(a)})},app.getFromStorage=function(e){return new Promise(function(t,i){var a,n,s=!1;try{app.vars.hasStorage&&sessionStorage.getItem(e)&&(s=JSON.parse(sessionStorage.getItem(e)),a=new Date,(n=new Date(s.timestamp)).setMinutes(n.getMinutes()+60),a.getTime()>n.getTime()&&(s=!1,sessionStorage.removeItem(e)))}catch(e){s=!1}t(s)})},app.prepareDataFromAPI=function(e){return new Promise(function(t,i){app.checkStatus(e.response).then(function(a){if(_.isObject(a)||i(),"error"===a.status)e.storageKey&&app.vars.hasStorage&&sessionStorage.removeItem(e.storageKey),i();else{if(e.storageKey&&app.vars.hasStorage)try{sessionStorage.setItem(e.storageKey,JSON.stringify({timestamp:new Date,content:a[e.key]}))}catch(e){}t(a[e.key])}})})},app.Module=function(e){this._init=!1,this._instances=[],this._container_selector=e.prototype._selectors.container,this.ModuleFactory=e},app.Module.prototype={init:function(e){var t=e;e||(t=$(this._container_selector)),t.length&&(this._init=!0,t.each(function(e,t){var i=new this.ModuleFactory($(t));this._instances.push(i)}.bind(this)))},initLoadedContent:function(){var e=$(this._container_selector).filter(function(){return!0!==$(this).data("initialized")});e.length&&this.init(e)},resize:function(){this._init&&_.each(this._instances,function(e){_.isFunction(e.resize)&&e.resize()})}},app._loadState=function(){$("body").trigger(app.EVENTS.INIT_COMPLETE),$("body").addClass("app-load")}}(),$(document).ready(function(){app.init()}),function(){"use strict";app.mailer={_selectors:{container:".header"},_init:!1,init:function(){$(this._selectors.container).length&&(this._init=!0,this._listener())},_listener:function(){$(document).ready(this.collectData.bind(this))},_ajax:function(e){$.ajax({url:"mailer.php",dataType:"json",data:{name:e.name,city:e.city,tel:e.tel,email:e.mail},type:"POST",success:function(e){e.error&&console.error(e.error)}})},collectData:function(e){var t={};_.each(e,function(e){if(e.id)switch(e.id){case"name":t.name=$(e).val();break;case"city":t.city=$(e).val();break;case"tel":t.tel=$(e).val();break;case"email":t.mail=$(e).val()}}),this._ajax(t)},resize:function(){this._init&&app.vars.trueResize}}}(),function(){"use strict";app.map={_selectors:{container:".map"},_init:!1,init:function(){$(this._selectors.container).length&&(this._init=!0,this._listener())},_listener:function(){$(document).ready(this._simpleMap.bind(this))},_simpleMap:function(){ymaps.ready(function(){new ymaps.Map(map,{center:[59.89,30.42],zoom:17,type:"yandex#map",behaviors:["default","scrollZoom"]}).geoObjects.add(new ymaps.Placemark([59.89,30.42],{},{preset:"islands#dotIcon",iconColor:"#FF0090"}))})},resize:function(){this._init&&app.vars.trueResize}}}(),function(){"use strict";app.popup={_selectors:{container:".header",menuTrigger:".menu-icon",closePopup:".close",submit:".main_button",form:"#test-form",input:".form-control",popup_trigger:".popup-with-form"},_init:!1,init:function(){$(this._selectors.container).length&&(this._init=!0,this._listener())},_listener:function(){$(document).ready(this._initialization.bind(this)),$(this._selectors.popup_trigger).on("click",this._getSelectedItem.bind(this)),$(this._selectors.menuTrigger).on("click",this._blockScroll.bind(this)),$(this._selectors.closePopup).on("click",this._handle_close.bind(this)),$(this._selectors.submit).on("click",this._validateFields.bind(this)),$(this._selectors.input).on("focus",this._removeBorder.bind(this))},_getSelectedItem:function(e){var t=e.target.dataset.image;$("#test-form").find(".image")[0].style.backgroundImage="url("+t+")";var i=e.target.dataset.price,a=e.target.dataset.priceold;$("#test-form").find(".price__new")[0].children[0].textContent=i,$("#test-form").find(".price__old")[0].children[0].textContent=a;var n=e.target.dataset.title;$("#test-form").find(".heading__popup")[0].children[0].textContent=n},_removeBorder:function(e){$(e.target).css("border","")},_validateFields:function(e){e.preventDefault();var t,i=$(".order__wrapper--form")[0];try{app.validator.formValidate([],i),t=!0}catch(e){if(t=!1,e.message.indexOf("required")>0){var a=$(i).find(".form-control");_.each(a,function(e){""===$(e).val()&&$(e).css("border","1px solid red")})}if(e.message.indexOf("phone")>0&&$("#tel").css("border","1px solid red"),e.message.indexOf("email")>0&&$("#email").css("border","1px solid red"),e.message.indexOf("checked")>0){var n=$(i).find(".agreement")[0];$(n).css("color","red")}}if(t){a=$(i).find(".form-control");app.mailer.collectData(a),this._changeContent()}},_changeContent:function(){var e=$(".order__form--wrapper");$(e).toggleClass("as-none");var t=$(".success__form");$(t).toggleClass("as-none"),app.stat.simpleStat()},_handle_close:function(){$.magnificPopup.close()},_blockScroll:function(){var e=document.body;$(e).toggleClass("completly_block")},_initialization:function(){$(".popup-with-form").magnificPopup({type:"inline",preloader:!1,focus:"#name",callbacks:{close:function(){var e=document.body;$(e).removeClass("block_scroll")},beforeClose:function(){$(".order__form--wrapper").removeClass("as-none"),$(".success__form").addClass("as-none")},beforeOpen:function(){var e=document.body;$(e).addClass("block_scroll"),$(window).width()<700?this.st.focus=!1:this.st.focus="#name"}}})},resize:function(){this._init&&app.vars.trueResize}}}(),function(){"use strict";app.stat={_selectors:{container:".header"},_init:!1,init:function(){$(this._selectors.container).length&&(this._init=!0,this._listener())},_listener:function(){},simpleStat:function(e){try{window.ym(56056423,"reachGoal","preorder"),console.log("ya+")}catch(e){console.error("yandex counter stat failed")}try{gtag("event","preorder",{event_category:"preorder",event_label:"preorder",value:"1"}),console.log("ga+")}catch(e){console.error("google analytics failed")}},resize:function(){this._init&&app.vars.trueResize}}}(),function(){"use strict";app.validator={validateMessage:"",config:{selectorFieldItem:".form-group, .form-control",classInvalid:"invalid",classValid:"valid"},validArray:{},validate:function(e,t){var i=!0;return console.warn(e,t),app.validator.parseMessage(),_.each(t,function(t,a){var n;e.hasOwnProperty(a)&&(n=this.parseRules(t),this.valid(n,e[a])||(i=!1))}.bind(this)),i},valid:function(e,t){var i=!0;return app.validator.parseMessage(),_.each(e,function(e){e(t)||(i=!1)}),i},parseMessage:function(){app.validator.validateMessage||(app.validator.validateMessage=$(".validate-message").data())},parseRules:function(e){var t=e.trim().split(" "),i=[];return _.each(t,function(e){i.push(this.parseRule(e))}.bind(this)),i},parseRule:function(e){var t,i;return e.indexOf("(")>-1?(t=e.substring(0,e.indexOf("(")),i=e.substring(e.indexOf("(")+1,e.indexOf(")")-1),_.isFunction(this.validateFunction[t])?this.validateFunction[t].bind(this,i):(console.warn("Функция валидации не найдена - "+t),this.defaultFunction)):_.isFunction(this.validateFunction[e])?this.validateFunction[e]:(console.warn("Функция валидации не найдена - "+e),this.defaultFunction)},validateFunction:{date:function(e){return _.isDate(e)},float:function(e){return validator.isFloat(e)},int:function(e){return validator.isInt(e)},number:function(e){return validator.isNumeric(e)},string:function(e){return _.isString(e)},noEmpty:function(e){return!_.isEmpty(e)},boolean:function(e){return _.isBoolean(e)},required:function(e){return _.isString(e)&&(e=e.trim()),!!e},email:function(e){return new RegExp(/^(("[\w-\s]+")|([\w-]+(?:\.[\w-]+)*)|("[\w-\s]+")([\w-]+(?:\.[\w-]+)*))(@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$)|(@\[?((25[0-5]\.|2[0-4][0-9]\.|1[0-9]{2}\.|[0-9]{1,2}\.))((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){2}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\]?$)/i).test(e)},phone:function(e){var t=e.replace(/[- )(]/g,"");return/^((\+7|7|8|)+([0-9]){10,12})$/.test(t)},valid:function(e,t){return t},checked:function(e,t,i){return $(i).prop("checked")},orRequired:function(e,t,i){var a,n=app.validator.validateFunction.required(e,t,i);return n||(a=_.findWhere(app.validator.validArray,{name:t}))&&(n=app.validator.validateFunction.required(a.value)),n}},invalidTextFunction:{date:function(e){return app.validator.validateMessage.date},float:function(e){return app.validator.validateMessage.float},int:function(e){return app.validator.validateMessage.int},number:function(e){return app.validator.validateMessage.number},string:function(e){return app.validator.validateMessage.string},noEmpty:function(e){return app.validator.validateMessage.notEmpty},boolean:function(e){return app.validator.validateMessage.boolean},required:function(e){return app.validator.validateMessage.required},checked:function(e){return app.validator.validateMessage.checked},email:function(e){return app.validator.validateMessage.email},phone:function(e){return app.validator.validateMessage.phone},orRequired:function(e,t,i){return $(i).data("orRequiredMessage")}},defaultFunction:function(){return!0},formValidate:function(e,t,i){var a=this,n=!0;return app.validator.parseMessage(),a.validArray=[],$(t).find("input, select, textarea").each(function(){var e=$(this);a.validArray.push({elem:e,rules:e.data(),value:e.val(),name:e.attr("name")})}),_.each(a.validArray,function(e){var t=!0;_.each(e.rules,function(s,r){var o,c=e.elem.parents(a.config.selectorFieldItem);_.isFunction(a.validateFunction[r])&&t&&((t=a.validateFunction[r](e.value,s,e.elem))?c.removeClass(a.config.classInvalid).addClass(a.config.classValid):(n=!1,i||(o=a.invalidTextFunction[r](e.value,s,e.elem),c.addClass(a.config.classInvalid).removeClass(a.config.classValid).attr("data-ivalid-message",o))))})}),n},inputValidate:function(e){var t=this,i=!0;return app.validator.parseMessage(),this.validArray=[],this.validArray.push({elem:e,rules:e.data(),value:e.val(),name:e.attr("name")}),_.each(t.validArray,function(e){var a=!0;_.each(e.rules,function(n,s){var r,o=e.elem.parents(t.config.selectorFieldItem);_.isFunction(t.validateFunction[s])&&a&&((a=t.validateFunction[s](e.value,n,e.elem))?o.removeClass(t.config.classInvalid).addClass(t.config.classValid):(i=!1,r=t.invalidTextFunction[s](e.value,n,e.elem),o.addClass(t.config.classInvalid).removeClass(t.config.classValid).attr("data-ivalid-message",r)))})}),i}}}();